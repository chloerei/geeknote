<div id="post-editor">
  <%= form_with model: @post, url: @post.new_record? ? dashboard_posts_path(@account.name) : dashboard_post_path(@account.name, @post), data: { controller: "form-unsave-checker" } do |form| %>
    <div class="drawer drawer-end">
      <input type="checkbox" id="drawer-toggle" class="drawer-toggle" />

      <div class="drawer-content">
        <div class="sticky top-0 z-10 bg-base-200 border-b border-base-300">
          <div class="max-w-7xl mx-auto">
            <div class="navbar">
              <div class="flex-grow">
                <a href="<%= dashboard_posts_path(@account.name) %>" class="btn btn-ghost">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left-icon lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                  <%= t "general.posts" %>
                </a>
                <% if @post.draft? %>
                  <div class="btn btn-disabled btn-ghost text-base-content/80">
                    <%= t "general.draft" %>
                  </div>
                <% elsif @post.published? %>
                  <a href="<%= account_post_path(@account.name, @post) %>" class="btn btn-ghost text-base-content/80" target="_blank">
                    <%= t "general.published" %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-right-icon lucide-arrow-up-right"><path d="M7 7h10v10"/><path d="M7 17 17 7"/></svg>
                  </a>
                <% end %>
              </div>
              <div class="flex-none">
                <% if @post.draft? %>
                  <button type="submit" class="btn btn-ghost" data-controller="hotkey" data-hotkey="Mod+s">
                    <%= t "general.save" %>
                  </button>
                  <% if @post.persisted? %>
                    <button type="submit" class="btn btn-ghost text-primary" form="publish-form">
                      <%= t "general.publish" %>
                    </button>
                  <% else %>
                    <button type="button" class="btn btn-ghost" disabled>
                      <%= t "general.publish" %>
                    </button>
                  <% end %>
                <% elsif @post.published? %>
                  <button type="submit" class="btn btn-ghost text-primary" data-controller="hotkey" data-hotkey="Mod+s">
                    <%= t "general.update" %>
                  </button>
                  <button type="submit" class="btn btn-ghost" form="unpublish-form">
                    <%= t "general.unpublish" %>
                  </button>
                <% end %>
                <label for="drawer-toggle" class="btn btn-ghost btn-square">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-panel-right-icon lucide-panel-right"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M15 3v18"/></svg>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="max-w-4xl mx-auto p-4">
          <div class="card card-lg card-border border-base-300 bg-base-100" data-turbo-permanent>
            <div class="card-body">
              <%= form.text_area :title, class: "text-3xl font-medium resize-none outline-none", placeholder: "Title", data: { controller: "autoresize" } %>

              <div class="group" data-controller="markdown-field">
                <%= form.hidden_field :content, id: "post_content", placeholder: "Markdown..." %>
                <markdown-editor input="<%= form.field_id :content %>" class="mt-4 min-h-screen" data-markdown-field-target="markdownEditor"></markdown-editor>

                <div class="sticky bottom-4 flex justify-center mt-4">
                  <div class="bg-base-200 p-1 rounded-box flex gap-1 shadow-sm">
                    <div class="join">
                      <button type="button" class="btn btn-ghost join-item not-group-[.previewing]:btn-active!" data-action="markdown-field#edit">
                        <%= t "general.edit" %>
                      </button>
                      <button type="button" class="btn btn-ghost join-item group-[.previewing]:btn-active!" data-action="markdown-field#preview">
                        <%= t "general.preview" %>
                      </button>
                    </div>
                    <div class="block group-[.previewing]:hidden">
                      <button type="button" class="btn btn-ghost btn-square" data-action="markdown-field#attachFile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paperclip-icon lucide-paperclip"><path d="m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551"/></svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="drawer-side z-10">
        <label for="drawer-toggle" class="drawer-overlay"></label>

        <div class="bg-base-100 text-base-content h-full w-80 flex flex-col">
          <div class="navbar border-b border-base-300">
            <div class="flex-grow px-2">
              <%= t "general.settings" %>
            </div>
            <label for="drawer-toggle" class="btn btn-ghost btn-square">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </label>
          </div>

          <div class="flex-grow p-4 overflow-auto">
            <div class="space-y-2">
              <%= render "components/image_field", form: form, name: :featured_image %>

              <fieldset class="fieldset">
                <legend class="fieldset-legend">
                  <%= t "general.tags" %>
                </legend>
                <div data-controller="tag-field">
                  <%= form.hidden_field :tag_list, data: { tag_field_target: "input" } %>
                </div>
              </fieldset>

              <%= render "components/text_field", form: form, name: :canonical_url %>

              <fieldset class="fieldset">
                <legend class="fieldset-legend">
                  <%= t "general.options" %>
                </legend>
                <%= render "components/checkbox_field", form: form, name: :allow_comments %>
              </fieldset>
            </div>

            <% if @post.persisted? %>
              <div class="divider"></div>

              <button type="submit" class="btn btn-outline btn-error" form="delete-form">
                <%= t "general.delete_post" %>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div class="hidden">
  <% if @post.persisted? %>
    <%= form_with model: @post, url: dashboard_post_publish_path(@account.name, @post), id: "publish-form", method: :patch do %>
    <% end %>
    <%= form_with model: @post, url: dashboard_post_publish_path(@account.name, @post), id: "unpublish-form", method: :delete do %>
    <% end %>
    <%= form_with model: @post, url: dashboard_post_trash_path(@account.name, @post), id: "restore-form", method: :delete do %>
    <% end %>
    <%= form_with model: @post, url: dashboard_post_trash_path(@account.name, @post), id: "trash-form", method: :patch do %>
    <% end %>
    <%= form_with model: @post, url: dashboard_post_path(@account.name, @post), id: "delete-form", method: :delete, data: { turbo_confirm: t(".delete_forever_confirm") } do %>
    <% end %>
  <% end %>
</div>
