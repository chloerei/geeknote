<div class="container padding-3">
  <div class="post-layout">
    <div></div>

    <div class="card card--elevated">
      <div class="display-flex gap-2 align-items-center padding-2 margin-1">
        <a href="<%= account_post_path(@account, @post) %>" class="button button--icon">
          <span class="material-icons">arrow_back</span>
        </a>
        <div class="title-medium">
          <%= @post.title %>
        </div>
      </div>

      <div class="padding-x-4 padding-y-3" id="comment-<%= @comment.id %>" data-controller="comment" data-comment-id-value="<%= @comment.id %>">
        <div class="display-flex gap-1 align-items-center margin-bottom-3">
          <div class="display-flex gap-2">
            <div class="avatar avatar--small">
              <%= avatar_image_tag @comment.user.avatar %>
            </div>
            <div>
              <b><%= @comment.user.name %></b>
            </div>
          </div>
          <span class="text-muted">&centerdot;</span>
          <a href="<%= account_post_comment_path(@account, @post, @comment) %>" class="link-text">
            <span class="text-muted"><%= format_time @comment.created_at %></span>
          </a>

          <div class="flex-grow-1"></div>

          <div class="dropdown dropdown--right">
            <label tabindex="0" class="button button--icon">
              <span class="material-icons">more_horiz</span>
            </label>
            <div tabindex="0" class="dropdown__container">
              <a href="<%= edit_account_post_comment_path(@account, @post, @comment) %>" class="dropdown__item" data-visible-to-user="<%= @comment.user_id %>">
                <%= t 'common.edit' %>
              </a>
              <%= form_with url: account_post_comment_path(@account, @post, @comment), method: 'delete', data: { 'visible-to-user': @comment.user_id, 'turbo-confirm': "Are you sure delete this comment?" } do |form| %>
                <button type="submit" class="dropdown__item">
                  <%= t 'common.delete' %>
                </button>
              <% end %>
            </div>
          </div>
        </div>

        <% if @comment.parent %>
          <a href="<%= account_post_comment_path(@account, @post, @comment.parent) %>" class="card card--outlined padding-3 margin-bottom-3">
            <div class="display-flex align-items-center gap-1">
              <span><%= t 'common.reply_to' %></span>
              <b><%= @comment.parent.user.name %></b>
              <span>&centerdot;</span>
              <span><%= format_time @comment.parent.created_at %></span>
            </div>
            <div>
              <%= comment_summary @comment.parent %>
            </div>
          </a>
        <% end %>

        <div class="typography margin-bottom-3">
          <%= markdown_render @comment.content %>
        </div>

        <div class="display-flex gap-3">
          <%= render 'account/posts/comments/likes/button', comment: @comment %>
        </div>
      </div>

      <div class="padding-x-4">
        <div class="divider"></div>
      </div>

      <div id="reply">
        <% if @post.allow_comments? %>
          <% if current_user %>
            <%= render 'form', comment: @comment.replies.new %>
          <% else %>
            <a href="<%= sign_in_path(return_to: url_for()) %>" class="button button--filled">
              <%= t 'common.sign_in_to_comment' %>
            </a>
          <% end %>
        <% else %>
          <div class="padding-3 text-muted text-align-center">
            <%= t 'common.comment_is_disabled' %>
          </div>
        <% end %>
      </div>

      <div id="comments" class="border-top divide-y" data-liked-ids="<%= "[#{@replies.filter(&:liked).map(&:id).join(',')}]" %>">
        <%= render partial: 'comment', collection: @replies, cached: true %>
      </div>

      <div class="margin-3">
        <%= paginate @replies %>
      </div>
    </div>

    <div>
      <div class="card card--elevated padding-3">
        <div class="display-flex gap-3 position-relative">
          <div class="avatar">
            <%= avatar_image_tag @comment.user.avatar %>
          </div>
          <div class="flex-grow-1">
            <div class="title-medium">
              <a href="<%= account_root_path(@comment.user.account) %>" class="link-text link-expended">
                <%= @comment.user.name %>
              </a>
            </div>
            <div class="body-medium">
              <%= @comment.user.bio %>
            </div>
          </div>
          <div>
            <% if @comment.user != current_user %>
              <%= render 'account/follows/button', account: @comment.user.account %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
